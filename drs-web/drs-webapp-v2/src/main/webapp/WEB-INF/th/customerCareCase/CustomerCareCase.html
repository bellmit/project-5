<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"  layout:decorate="~{th/layout.html}"
 xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
<title
	th:text="#{ccc.edit}+': '+#{ccc.name}+' - DRS'"	>	
</title>
<link th:href="@{/resources/css/bootstrap-multiselect.css}" type="text/css" rel="stylesheet">
<link th:href="@{/resources/css/bootstrap-example.css}" type="text/css" rel="stylesheet">
<link th:href="@{/resources/css/prettify.css}" type="text/css" rel="stylesheet">
<script type='text/javascript' th:src="@{/resources/js/bootstrap-multiselect.js}"></script>
<script type='text/javascript' th:src="@{/resources/js/bootstrap-multiselect-collapsible-groups.js}"></script>
<script type='text/javascript' th:src="@{/resources/js/prettify.js}"></script>	
	

<link rel="stylesheet" type="text/css" th:href="@{/resources/css/jquery-ui-timepicker-addon.css}"></link>
<script type='text/javascript' th:src="@{/resources/js/jquery-ui-timepicker-addon.js}"></script>
<!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script> -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>	


<style>

.dropdown-menu {
max-height: 500px;
overflow-y: auto;
overflow-x: hidden;
}
.checkbox input[type="checkbox"] {
    opacity: 1 !important;
    z-index: 1;
}

</style>

<script  th:inline="javascript">	
jQuery(window).on("load", function(e) {
		var control = {
			create : function(tp_inst, obj, unit, val, min,max, step) {
			$('<input class="ui-timepicker-input" value="'+ val + '" style="width:50%">')
				.appendTo(obj)
				.spinner({
					min : min,
					max : max,
					step : step,
					change : function(e, ui) { // key events
						// don't call if api was used and not key press
						if (e.originalEvent !== undefined)
							tp_inst._onTimeChange();
							tp_inst._onSelectHandler();
					},
					spin : function(e, ui) { // spin events
						tp_inst.control.value( tp_inst, obj, unit, ui.value);
						tp_inst._onTimeChange();
						tp_inst._onSelectHandler();
					}
				});
			return obj;
			},
			options : function(tp_inst, obj, unit, opts, val) {
				if (typeof (opts) == 'string' && val !== undefined)
					return obj.find('.ui-timepicker-input').spinner(opts, val);
					return obj.find('.ui-timepicker-input').spinner(opts);
			},
			value : function(tp_inst, obj, unit, val) {
				if (val !== undefined)
					return obj.find('.ui-timepicker-input').spinner('value', val);
					return obj.find('.ui-timepicker-input').spinner('value');
			}
		};		
		jQuery("#dateCreated,#marketplaceOrderDate").datetimepicker({
			beforeShow: function() {
				setTimeout(function(){
					$('.ui-datepicker').css('z-index', 200);
				}, 0);
			},
			controlType : control,
			dateFormat : "yy-mm-dd",
			timeFormat : 'HH:mm z',
			timezoneList : [ {
				value : +480,
				label : 'Taipei'
			}, {
				value : -480,
				label : 'Pacific'
			} ]
		});						
		$("#dateCreated,#marketplaceOrderDate").attr('readonly', true);							
	});

	$(document).ready(function() {		


		$('#example-multiple-optgroups').multiselect();
		$(".multiselect").css("width", "100%");
		$(".btn-group").css("width", "100%");
		$(".multiselect-container").css("width", "100%");
		$("#supplier").select2({ theme: "bootstrap"});

	});
	
	angular.module('customerCareCase', []).controller('customerCareCaseCtrl',function($scope) {						
		var currentURL = document.URL;
		var marketplaceMapJson =/*[[${marketplaceMapJson}]]*/{};
		var marketplaceIdToDrsCompanyMapJson = /*[[${marketplaceIdToDrsCompanyMapJson}]]*/{};
		var marketplaceToDrsCompanyMapJson = /*[[${marketplaceToDrsCompanyMapJson}]]*/{};
		

		
		
		
		$scope.baseProductLineItems = [];
		$scope.SKULineItems = [];										
		if(currentURL.indexOf("edit") > -1){						
		

		var CustomerCareCaseJson = /*[[${CustomerCareCaseJson}]]*/ {};
		
			

			$scope.withOrderIds = [];
			$scope.noneOrderIds = [];													
			$scope.caseType = CustomerCareCaseJson.caseType;							
			//marketplaceOrderId
			if(CustomerCareCaseJson.marketplaceOrderId != "" && CustomerCareCaseJson.marketplaceOrderId != null){								
				$('#orderIdYes').prop('checked', true);											
				$scope.withOrderIds.push({
					marketplaceOrderId:CustomerCareCaseJson.marketplaceOrderId,
					marketplace:CustomerCareCaseJson.marketplace,
					marketplaceOrderDate:CustomerCareCaseJson.marketplaceOrderDate,
					customerName:CustomerCareCaseJson.customerName,
					drsCompanyKcode:marketplaceToDrsCompanyMapJson[CustomerCareCaseJson.marketplace]
				});																																																
			}else{								
				$('#orderIdNo').prop('checked', true);								
				$scope.noneOrderIds.push({
					customerName:CustomerCareCaseJson.customerName,
					marketplace:CustomerCareCaseJson.marketplace,
					drsCompanyKcode:marketplaceToDrsCompanyMapJson[CustomerCareCaseJson.marketplace]
				});																								
			}																					
			$scope.supplier = CustomerCareCaseJson.supplierKcode;							
			$scope.issueTypeCategory = CustomerCareCaseJson.issueTypeCategoryId
			$scope.dateCreated = CustomerCareCaseJson.dateCreated;								
			$scope.relatedIssueIds = [];							
			for (i = 0; i < CustomerCareCaseJson.relatedIssueIds.length; i++) { 								
				$scope.relatedIssueIds[i] = CustomerCareCaseJson.relatedIssueIds[i];															
			}																
			$scope.message = CustomerCareCaseJson.message[CustomerCareCaseJson.message.length - 1]["contents"];
			var ajaxUrlForIssueTypeToIssuesMap = '/CustomerCareCases/getIssueTypeToIssuesMap/';
			var issueTypeToIssuesMap = null;
			var baseList = null;
			var skuList = null;							
			if(CustomerCareCaseJson.relatedProductBaseCodeList != null) baseList = CustomerCareCaseJson.relatedProductBaseCodeList.toString();
			if(CustomerCareCaseJson.relatedProductSkuCodeList != null) skuList = CustomerCareCaseJson.relatedProductSkuCodeList.toString();							
			$.ajax({
				type : 'get',
				url : ajaxUrlForIssueTypeToIssuesMap,
				contentType : "application/json; charset=utf-8",
				data : {
					baseList : baseList,
					skuList : skuList,
					category : Number(CustomerCareCaseJson.issueTypeCategoryId)
				},
				dataType : "json",
				success : function(data) {
					issueTypeToIssuesMap = data
					$("#example-multiple-optgroups").children().remove("optgroup");
																		
					if(Object.keys(issueTypeToIssuesMap).length > 0){
										
						var $select = $('#example-multiple-optgroups');
						$.each(issueTypeToIssuesMap, function(key, value){
							var group = $('<optgroup label="' + key + '" />');
								$.each(value, function(key,value){
									$('<option />').val(key).html(value).appendTo(group);
								});
							group.appendTo($select);
						});																			   
					}									
					$('#example-multiple-optgroups').val(CustomerCareCaseJson.relatedIssueIds);									
					$('#example-multiple-optgroups').multiselect('rebuild');																											
				}																			
			});	
																					
			if(CustomerCareCaseJson.relatedProductBaseCodeList != null){
		
				$("#relatedProduct-BP").prop('checked', true);
								
				$("#sku").hide();
				$("#baseProduct").show();
								
				var relatedProductBaseCodeList = CustomerCareCaseJson.relatedProductBaseCodeList;
								
				for(var baseCode in relatedProductBaseCodeList){
									
					if (relatedProductBaseCodeList.hasOwnProperty(baseCode)) {
									
						$scope.baseProductLineItems.push({baseProduct : relatedProductBaseCodeList[baseCode]});
									
					}
									
				}
				
				var supplierKcode = CustomerCareCaseJson.supplierKcode;
				var marketplace = CustomerCareCaseJson.marketplace;
				var ajaxUrl = '/CustomerCareCases/getProductBaseCodeToSupplierNameMap/';
				var productBaseCodeToSupplierNameMap = null;

				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						supplierKcode : supplierKcode
					},
					dataType : "json",
					success : function(data) {
						productBaseCodeToSupplierNameMap = data;				
						for (i = 0; i < $scope.baseProductLineItems.length; i++) {											
							emptyList("baseProduct" + i);											
							if (Object.keys(productBaseCodeToSupplierNameMap).length > 0) {
								var selectBaseCode = document.getElementById("baseProduct"+ i);
								var optBaseCode = document.createElement("option");
								optBaseCode.value = "";
								optBaseCode.textContent = "--- Select Base Product ---";
								selectBaseCode.appendChild(optBaseCode);
							}											
							for ( var key in productBaseCodeToSupplierNameMap) {
								optBaseCode = document.createElement("option");
								optBaseCode.value = key;
								optBaseCode.textContent = key + " " + productBaseCodeToSupplierNameMap[key];
								selectBaseCode.appendChild(optBaseCode);
							}																						
							selectBaseCode.value = CustomerCareCaseJson['relatedProductBaseCodeList'][i];																																	
						}//end for (i = 0; i < $scope.baseProductLineItems.length; i++)																																																		
					}																																			
				});																																								
			}else if(CustomerCareCaseJson.relatedProductSkuCodeList != null){								
				$("#relatedProduct-SKU").prop('checked', true);								
				$("#sku").show();
				$("#baseProduct").hide();								
				var relatedProductSkuCodeList = CustomerCareCaseJson.relatedProductSkuCodeList;				
				for(var skuCode in relatedProductSkuCodeList) {		
											
					if (relatedProductSkuCodeList.hasOwnProperty(skuCode)) {
						
						$scope.SKULineItems.push({sku : relatedProductSkuCodeList[skuCode]});
													
					}									
				}											
				
				
			
				var supplierKcode = CustomerCareCaseJson.supplierKcode;
				var marketplace = CustomerCareCaseJson.marketplace;								
				var ajaxUrl = '/CustomerCareCases/getProductSkuCodeToSupplierNameMap/';
				var productSkuCodeToSupplierNameMap = null;
				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						supplierKcode : supplierKcode
					},
					dataType : "json",
					success : function(data) {
						productSkuCodeToSupplierNameMap = data;
						for (i = 0; i < $scope.SKULineItems.length; i++) {
							emptyList("sku" + i);
							if (Object.keys(productSkuCodeToSupplierNameMap).length > 0) {
								var selectSku = document.getElementById("sku"+ i);
								var optSku = document.createElement("option");
								optSku.value = "";
								optSku.textContent = "--- Select SKU ---";
								selectSku.appendChild(optSku);
							}
						
							
							for ( var key in productSkuCodeToSupplierNameMap) {
								optSku = document.createElement("option");
								optSku.value = key;
								optSku.textContent = key + " " + productSkuCodeToSupplierNameMap[key];
								selectSku.appendChild(optSku);
								
							}												
							selectSku.value = CustomerCareCaseJson['relatedProductSkuCodeList'][i];
							
						} //end for(i = 0; i < $scope.SKULineItems.length; i++)
					}
				});																						
			}															
			}else{							
				$scope.SKULineItems = [{sku : ''}];
				$scope.withOrderIds = [];
				$scope.noneOrderIds = [{noneOrder : ''}];							
			}
						
			$scope.checkOrderId = function() {													
				var checkedValue = null;							
				if (document.getElementById('orderIdYes').checked) {
					checkedValue = document.getElementById('orderIdYes').value;
				}							
				if (document.getElementById('orderIdNo').checked) {
					checkedValue = document.getElementById('orderIdNo').value;
				}														
				if (checkedValue == "yes") {
					$scope.withOrderIds = [{withOrder : ''}];
					$scope.noneOrderIds = [];								
				} else {	
					$scope.withOrderIds = [];
					$scope.noneOrderIds = [{noneOrder : ''}];																							
				}																											
			};
												
			$scope.getDrsCompany = function() {					
				var marketplace = $("#marketplace").val();													    
				if($scope.withOrderIds.length==1)$scope.withOrderIds[0]["drsCompanyKcode"] = marketplaceToDrsCompanyMapJson[marketplace];
				if($scope.noneOrderIds.length==1)$scope.noneOrderIds[0]["drsCompanyKcode"] = marketplaceToDrsCompanyMapJson[marketplace];							
				$scope.getRelatedProductList();														
			};

			$scope.addBaseProductLineItem = function() {
				$scope.baseProductLineItems.push({baseProduct : ''});
				updateProductBaseCodeToSupplierNameMap($scope.baseProductLineItems.length - 1);
			};

			$scope.removeBaseProductLineItem = function( baseProductLineItem) {
				if ($scope.baseProductLineItems.length > 1) {
					var idx = $scope.baseProductLineItems.indexOf(baseProductLineItem);
					$scope.baseProductLineItems.splice(idx, 1);
				}
				$scope.updateBaseProductList();
			};

			$scope.addSKULineItem = function() {
				$scope.SKULineItems.push({sku : ''});
				updateProductSkuCodeToSupplierNameMap($scope.SKULineItems.length - 1);
			};

			$scope.removeSKULineItem = function(SKULineItem) {
				if ($scope.SKULineItems.length > 1) {
					var idx = $scope.SKULineItems.indexOf(SKULineItem);
					$scope.SKULineItems.splice(idx, 1);
				}
				$scope.updateSkuList();
			};

			$scope.checkRelatedProduct = function() {
				var id = document.querySelector('input[name="relatedProduct"]:checked').id;
				var supplierKcode = document.getElementById('supplier').value;
				
				if(document.getElementById('marketplace') != null){
					marketplace = document.getElementById('marketplace').value;		
				}else{
					marketplace = $scope.withOrderIds[0]["marketplace"]
				}	

									
				if (id == "relatedProduct-BP") {
					for (var i = $scope.SKULineItems.length - 1; i >= 0; i--) {
						$scope.SKULineItems.splice(i, 1);
					}								
					$('#relatedProductSkuCodeList').val("");								
					document.getElementById("sku").style.display = "none";
					document.getElementById("baseProduct").style.display = "block";
					$scope.baseProductLineItems = [{baseProduct : ''}];
					getProductBaseCodeToSupplierNameMap(supplierKcode,marketplace);
					$scope.getIssueTypeToIssues();																
				} else if (id == "relatedProduct-SKU") {
					for (var i = $scope.baseProductLineItems.length - 1; i >= 0; i--) {
						$scope.baseProductLineItems.splice(i, 1);
					}								
					$('#relatedProductBaseCodeList').val("");
					document.getElementById("baseProduct").style.display = "none";
					document.getElementById("sku").style.display = "block";
					$scope.SKULineItems = [{sku : ''}];
					
					getProductSkuCodeToSupplierNameMap(supplierKcode,marketplace);
					$scope.getIssueTypeToIssues();
				}
			};

			$scope.updateSkuList = function() {
				var skuArray = new Array();
				for ( var key in $scope.SKULineItems) {                                
					if ($scope.SKULineItems.hasOwnProperty(key)) {								
						if ($scope.SKULineItems[key]['sku'] !== "") {
							
							skuArray.push($scope.SKULineItems[key]['sku']);
						}								
					}
				}
				document.getElementById('relatedProductSkuCodeList').value = skuArray.toString();
				$scope.getIssueTypeToIssues();							
			};

			$scope.updateBaseProductList = function() {
				var baseProductArray = new Array();							
				for ( var key in $scope.baseProductLineItems) {
					if ($scope.baseProductLineItems.hasOwnProperty(key)) {								
						if ($scope.baseProductLineItems[key]['baseProduct'] !== "") {
							baseProductArray.push($scope.baseProductLineItems[key]['baseProduct']);
						}								
					}
				}
				document.getElementById('relatedProductBaseCodeList').value = baseProductArray.toString();							
				$scope.getIssueTypeToIssues();							
			};

			$scope.getRelatedProductList = function() {
			
				var id = document.querySelector('input[name="relatedProduct"]:checked').id;
				var supplierKcode = document.getElementById('supplier').value;
				
				var marketplace = ""
				if(document.getElementById('marketplace') != null){
					marketplace = document.getElementById('marketplace').value;		
				}else{
					marketplace = $scope.withOrderIds[0]["marketplace"]
				}
				
			
				if (id == "relatedProduct-BP") {
					$scope.SKULineItems = [];
					$scope.baseProductLineItems = [{baseProduct : ''}];
					getProductBaseCodeToSupplierNameMap(supplierKcode,marketplace);
					$scope.getIssueTypeToIssues();								
				} else if (id == "relatedProduct-SKU") {
					$scope.baseProductLineItems = [];
					$scope.SKULineItems = [{sku : ''}];
					getProductSkuCodeToSupplierNameMap(supplierKcode,marketplace);
					$scope.getIssueTypeToIssues();								
				}
			};
			$scope.geOrderInfo = function() {														
				isOrderIdExist();							
			};
												
			function isOrderIdExist(){														
				var orderId = $('#marketplaceOrderId').val();
				var ajaxUrl = '/CustomerCareCases/geOrderInfo/';
				var orderInfo = null;                            
				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {orderId : orderId},
					dataType : "json",
					success : function(data) {											
						orderInfo = data;																						
						if(orderInfo != null){												
							$scope.withOrderIds[0]["marketplace"] = marketplaceMapJson[orderInfo['marketpaceId']];
							$scope.withOrderIds[0]["marketplaceOrderDate"] = orderInfo['orderDate'];
							$scope.withOrderIds[0]["customerName"] = orderInfo['customerName'];
							$scope.withOrderIds[0]["drsCompanyKcode"] = marketplaceIdToDrsCompanyMapJson[orderInfo['marketpaceId']];
						}else{												
							$scope.withOrderIds[0]["marketplace"] = "";
							$scope.withOrderIds[0]["marketplaceOrderDate"] = "";
							$scope.withOrderIds[0]["customerName"] = "";
							$scope.withOrderIds[0]["drsCompanyKcode"] = "";																								
						}			
											
						$scope.$apply();											
					}																							
				});							
			}
												
			function emptyList(id) {
				document.getElementById(id).options.length = 0;
			}

			function getProductBaseCodeToSupplierNameMap(supplierKcodeParam,marketplaceParam) {
				var supplierKcode = supplierKcodeParam;
				var marketplace = marketplaceParam;
				var ajaxUrl = '/CustomerCareCases/getProductBaseCodeToSupplierNameMap/';
				var productBaseCodeToSupplierNameMap = null;
				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						supplierKcode : supplierKcode
					},
					dataType : "json",
					success : function(data) {
						productBaseCodeToSupplierNameMap = data;
						for (i = 0; i < $scope.baseProductLineItems.length; i++) {
							emptyList("baseProduct" + i);
							if (Object.keys(productBaseCodeToSupplierNameMap).length > 0) {
								var selectBaseProduct = document.getElementById("baseProduct"+ i);
								var optBaseProduct = document.createElement("option");
								optBaseProduct.value = "";
								optBaseProduct.textContent = "--- Select Base Product ---";
								selectBaseProduct.appendChild(optBaseProduct);
							}
							for ( var key in productBaseCodeToSupplierNameMap) {
								optBaseProduct = document.createElement("option");
								optBaseProduct.value = key;
								optBaseProduct.textContent = key + " "+ productBaseCodeToSupplierNameMap[key];
								selectBaseProduct.appendChild(optBaseProduct);
							}
						}//end for(i = 0; i < $scope.baseProductLineItems.length; i++) 
					}
				});
			}

			function updateProductBaseCodeToSupplierNameMap(id) {
				var supplierKcode = document.getElementById('supplier').value;
				var ajaxUrl = '/CustomerCareCases/getProductBaseCodeToSupplierNameMap/';
				var productBaseCodeToSupplierNameMap = null;
				if (supplierKcode != "" && marketplace !="") {
					$.ajax({
						type : 'get',
						url : ajaxUrl,
						contentType : "application/json; charset=utf-8",
						data : {
							supplierKcode : supplierKcode
						},
						dataType : "json",
						success : function(data) {
							productBaseCodeToSupplierNameMap = data;
							emptyList("baseProduct" + id);
							if (Object.keys(productBaseCodeToSupplierNameMap).length > 0) {
								var selectBaseProduct = document.getElementById("baseProduct"+ id);
								var optBaseProduct = document.createElement("option");
								optBaseProduct.value = "";
								optBaseProduct.textContent = "--- Select Base Product ---";
								selectBaseProduct.appendChild(optBaseProduct);
							}
							for ( var key in productBaseCodeToSupplierNameMap) {
								optBaseProduct = document.createElement("option");
								optBaseProduct.value = key;
								optBaseProduct.textContent = key + " " + productBaseCodeToSupplierNameMap[key];
								selectBaseProduct.appendChild(optBaseProduct);
							}
						}
					});
				}// end if(supplierKcode !="")
			}

			function getProductSkuCodeToSupplierNameMap(supplierKcodeParam,marketplaceParam) {

				var supplierKcode = supplierKcodeParam;
				var marketplace = marketplaceParam;
				var ajaxUrl = '/CustomerCareCases/getProductSkuCodeToSupplierNameMap/';
				var productSkuCodeToSupplierNameMap = null;

				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						supplierKcode : supplierKcode
					},
					dataType : "json",
					success : function(data) {
						productSkuCodeToSupplierNameMap = data;

						for (i = 0; i < $scope.SKULineItems.length; i++) {

							emptyList("sku" + i);

							if (Object.keys(productSkuCodeToSupplierNameMap).length > 0) {

								var selectSku = document.getElementById("sku"+ i);
								var optSku = document.createElement("option");
								optSku.value = "";
								optSku.textContent = "--- Select SKU ---";
								selectSku.appendChild(optSku);

							}
							
							for ( var key in productSkuCodeToSupplierNameMap) {
								optSku = document.createElement("option");
								optSku.value = key;
								optSku.textContent = key + " " + productSkuCodeToSupplierNameMap[key];
								selectSku.appendChild(optSku);
							}
						
						} //end for(i = 0; i < $scope.SKULineItems.length; i++)

					}

				});

			}

			function updateProductSkuCodeToSupplierNameMap(id) {
			
				var supplierKcode = document.getElementById('supplier').value;
				var ajaxUrl = '/CustomerCareCases/getProductSkuCodeToSupplierNameMap/';
				var productSkuCodeToSupplierNameMap = null;
				if (supplierKcode != "" && marketplace != "") {
				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						supplierKcode : supplierKcode
					},
					dataType : "json",
					success : function(data) {
						productSkuCodeToSupplierNameMap = data;
						emptyList("sku" + id);
						if (Object.keys(productSkuCodeToSupplierNameMap).length > 0) {
							var selectSku = document.getElementById("sku" + id);
							var optSku = document.createElement("option");
							optSku.value = "";
							optSku.textContent = "--- Select SKU ---";
							selectSku.appendChild(optSku);
						}
						for ( var key in productSkuCodeToSupplierNameMap) {
							optSku = document.createElement("option");
							optSku.value = key;
							optSku.textContent = key + " " + productSkuCodeToSupplierNameMap[key];
							selectSku.appendChild(optSku);
						}
					}
				});
				}// end if(supplierKcode !="") 								   
			}
												
			$scope.getIssueTypeToIssues = function(){							
				var baseList = $('#relatedProductBaseCodeList').val();
				var skuList = $('#relatedProductSkuCodeList').val();
				var category = $('#issueTypeCategory').val();					
				$scope.relatedIssueIds = "";							
				retrieveIssueTypeToIssues(baseList,skuList,category);						
			};	
					
			function retrieveIssueTypeToIssues(baseList,skuList,category){														
				var ajaxUrl = '/CustomerCareCases/getIssueTypeToIssuesMap/';
				var issueTypeToIssuesMap = null;					
				$.ajax({
					type : 'get',
					url : ajaxUrl,
					contentType : "application/json; charset=utf-8",
					data : {
						baseList : baseList,
						skuList : skuList,
						category : category
					},
					dataType : "json",
					success : function(data) {
						issueTypeToIssuesMap = data										
						$("#example-multiple-optgroups").children().remove("optgroup");																																				
						if(Object.keys(issueTypeToIssuesMap).length > 0){										
							var $select = $('#example-multiple-optgroups');
							$.each(issueTypeToIssuesMap, function(key, value){
								var group = $('<optgroup label="' + key + '" />');
								$.each(value, function(key,value){
									$('<option />').val(key).html(value).appendTo(group);
								});
								group.appendTo($select);
							});																			   
						}									

						$('#example-multiple-optgroups').multiselect('rebuild');																																																												
					}																														
				});								
			}																								
		});
</script>
</head>
<body>
	<section layout:fragment="custom-content">
<div class="container" ng-app="customerCareCase" ng-controller="customerCareCaseCtrl">
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-12">
				<div class="page-heading">
					
						<div th:if="${type eq 'Create'}">
							<a th:text="#{ccc.create}"></a>
							<script>
								$(document).ready(function(){
									$('#form').attr("action","/CustomerCareCases/save")
									
									document.title='[[#{ccc.create}]]'+' - DRS'
								});
								
							</script>
							
						</div>
						<div th:unless="${type eq 'Create'}">
							<a th:text="#{ccc.edit}"></a>: <a th:text="#{ccc.name}"></a>
			    			<script>
								$(document).ready(function(){
									$('#form').attr("action","/CustomerCareCases/update")
								});
								
							</script>
						</div>
					
				</div>
				<span class="text-danger"><a th:text="#{ccc.tempValidation}"></a></span>	
			</div>
		</div>		
		<form  id="form"  name="CustomerCareCase" class="form-horizontal text-left"   method="POST">
		
		<div class="row">
		<div class="col-sm-6">

		
			<div th:if="${type eq 'Edit'}">
		<div class="form-group row">
		    <label for="caseId" class="col-sm-4 col-form-label"><a th:text="#{ccc.id}"></a></label>
		    <div class="col-sm-8">
		      <input id="caseId" th:value="${caseId}" name="caseId" class="form-control" readonly="true" >
		    </div>
		  </div>
			</div>
		
		  
		  <div class="form-group row">
		    <label for="caseType" class="col-sm-4 col-form-label"><a th:text="#{ccc.caseType}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
					<th:block th:if="${type eq 'Create'}">
						<input type="hidden" id="caseId"  >
					</th:block>
					
						<select id="caseType" class="form-control" name="caseType" ng-model="caseType" th:required="required" >
							<option value="">--- Select ---</option>
							<th:block th:each="caseType : ${caseTypeList}">									
								<option th:value="${caseType}" th:text="#{'ccc.'+${caseType}}" th:selected="${caseType}==${CustomerCareCase.caseType}"></option>								
							</th:block>
						</select>							
				<small class="text-danger form-text" ng-show="CustomerCareCase.caseType.$error.required && CustomerCareCase.caseType.$dirty">
					<a th:text="#{ccc.caseType_req}"></a>
				</small>
		    </div>
		  </div>
		  
		  <div class="form-group row">
		    <label for="orderId" class="col-sm-4 col-form-label"><a th:text="#{ccc.orderId}"></a></label>
		    <div class="col-sm-8">
		      <div class="form-check form-check-inline">
				  <input class="form-check=input" id="orderIdYes" name="orderId"  th:value="yes" type="radio" ng-click="checkOrderId()" >
				  <label class="form-check-label" for="inlineCheckbox1"><a th:text="#{ccc.orderIdYes}"></a></label>
				</div>
				<div class="form-check form-check-inline">
				  <input class="form-check=input" id="orderIdNo" name="orderId" th:value="no" type="radio" ng-click="checkOrderId()" checked>
				  <label class="form-check-label" for="inlineCheckbox2"><a th:text="#{ccc.orderIdNo}"></a></label>
				</div>
		    </div>
		  </div>
		  
		  <div class="form-group row" ng-repeat="withOrderId in withOrderIds" >
		    <label for="marketplaceOrderId" class="col-sm-4 col-form-label"><a th:text="#{ccc.marketplaceOrderId}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="marketplaceOrderId" class="form-control" th:value="${marketplaceOrderId}" ng-model="withOrderId.marketplaceOrderId" ng-change="geOrderInfo();" th:required="required"/>						
				<small class="text-danger form-text" ng-show="CustomerCareCase.marketplaceOrderId.$error.required && CustomerCareCase.marketplaceOrderId.$dirty">
					<a th:text="#{ccc.orderId_req}"></a> 
				</small>
		    </div>
		  </div>
		  
		  <div class="form-group row" ng-repeat="withOrderId in withOrderIds">
		    <label for="marketplaceOrderDate" class="col-sm-4 col-form-label"><a th:text="#{ccc.orderDate}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="marketplaceOrderDate" class="form-control" style="display:inline;cursor:default;background-color:white;" th:value="${marketplaceOrderDate}" ng-model="withOrderId.marketplaceOrderDate" th:required="required"/>
							<small class="text-danger form-text" ng-show="CustomerCareCase.marketplaceOrderDate.$error.required && CustomerCareCase.marketplaceOrderDate.$dirty">
								<a th:text="#{ccc.orderDate_req}"></a> 
							</small>
		    </div>
		  </div>
		  
		  <div class="form-group row" ng-repeat="withOrderId in withOrderIds" >
		    <label for="customerName" class="col-sm-4 col-form-label"><a th:text="#{ccc.customerName}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="customerName" class="form-control" name="customerName" th:value="${customerName}" ng-model="withOrderId.customerName" th:required="required"/>
							<small class="text-danger form-text" ng-show="CustomerCareCase.customerName.$error.required && CustomerCareCase.customerName.$dirty">
								<a th:text="#{ccc.customerName_req}"></a>
							</small>
		    </div>
		  </div>

		   <div class="form-group row" ng-repeat="withOrderId in withOrderIds">
		    <label for="DRSCompany" class="col-sm-4 col-form-label"><a th:text="#{ccc.drsCompany}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="DRSCompany"  name="drsCompanyKcode" th:value="${drsCompanyKcode}" class="form-control"  ng-model="withOrderId.drsCompanyKcode" th:required="required" readonly="true"/>
				<small class="text-danger form-text" ng-show="CustomerCareCase.drsCompanyKcode.$error.required && CustomerCareCase.drsCompanyKcode.$dirty">
					<a th:text="#{ccc.drsCompany_req}"></a> 
				</small>
		    </div>
		  </div>

		  <div class="form-group row" ng-repeat="noneOrderId in noneOrderIds" >
		    <label for="customerName" class="col-sm-4 col-form-label"><a th:text="#{ccc.customerName}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="customerName" class="form-control" name="customerName" th:value="${customerName}" ng-model="noneOrderId.customerName" th:required="required"/>
							<small class="text-danger form-text" ng-show="CustomerCareCase.customerName.$error.required && CustomerCareCase.customerName.$dirty">
								<a th:text="#{ccc.customerName_req}"></a>
							</small>
		    </div>
		  </div>
		  
		  <div class="form-group row" ng-repeat="noneOrderId in noneOrderIds">
		    <label for="marketplace" class="col-sm-4 col-form-label"><a th:text="#{common.marketplace}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <select id="marketplace" class="form-control" name="marketplace" ng-model="noneOrderId.marketplace" ng-change="getDrsCompany()" required="required">
				<option value="">--- Select ---</option>
				<th:block th:each="m : ${marketplaceList}">
					<option th:value="${m.name()}" th:text="${m.name}"></option>
				</th:block>
			</select>	
			<small class="text-danger form-text" ng-show="CustomerCareCase.contactChannel.$error.required && CustomerCareCase.contactChannel.$dirty">
				<a th:text="#{ccc.marketplace_req}"></a>
			</small>		
		    </div>
		  </div>
		  
		   <div class="form-group row" ng-repeat="noneOrderId in noneOrderIds">
		    <label for="DRSCompany" class="col-sm-4 col-form-label"><a th:text="#{ccc.drsCompany}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="DRSCompany" class="form-control" name="drsCompanyKcode" th:value="${drsCompanyKcode}" ng-model="noneOrderId.drsCompanyKcode" th:required="required" readonly="true"/>
				<small class="text-danger form-text" ng-show="CustomerCareCase.drsCompanyKcode.$error.required && CustomerCareCase.drsCompanyKcode.$dirty">
					<a th:text="#{ccc.drsCompany_req}"></a>
				</small>
		    </div>
		  </div>
		  
		  <div class="form-group row">
		    <label for="supplier" class="col-sm-4 col-form-label"><a th:text="#{ccc.supplier}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		        <select id="supplier" class="form-control"
								name="supplierKcode" ng-model="supplier"
								ng-change="getRelatedProductList()" th:required="required">
								<option value="" >--- Select ---</option>
								<th:block th:each="supplier : ${supplierKcodeToShortEnUsNameMap}">
								<option th:value="${supplier.key}" th:text="${supplier.key}+' '+${supplier.value}" th:selected="${supplier.key}==${CustomerCareCase.supplierKcode}"></option>
								</th:block>
				</select>						
							<div class="text-danger" ng-show="CustomerCareCase.supplierKcode.$error.required && CustomerCareCase.supplierKcode.$dirty">
								<a th:text="#{ccc.supplier_req}"></a>
							</div>
		    </div>
		  </div>
		  
		  <div class="form-group row">
		    <label for="relatedProduct-BP" class="col-sm-4 col-form-label"><a th:text="#{ccc.relatedProduct}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <div class="form-check form-check-inline">
				   <input class="form-check-input" name="relatedProduct" id="relatedProduct-BP" value="Base Product" type="radio" ng-click="checkRelatedProduct()">
				  <label class="form-check-label" for="inlineCheckbox1"><a th:text="#{ccc.baseProduct}"></a></label>
				</div>
		     
		      
			<div class="form-check form-check-inline">
			  <input name="relatedProduct" class="form-check-input" id="relatedProduct-SKU" value="SKU" type="radio" ng-click="checkRelatedProduct()" checked="TRUE">
			  <label class="form-check-label" for="inlineCheckbox1"><a th:text="#{ccc.sku}"></a></label>
			</div>
		    </div>
		  </div>
		  
		  <div id="baseProduct" style="display: none;">
		<div ng-repeat="baseProductLineItem in baseProductLineItems">
		  <div class="form-group row">
		    <label for="baseProduct" class="col-sm-4 col-form-label"> Product </label>
		    <div class="col-sm-6">
		      <select id="baseProduct{{$index}}" class="form-control"
												name="baseProduct{{$index}}" ng-model="baseProductLineItem.baseProduct"
												ng-change="updateBaseProductList()" th:required="required">
											</select>	
											<small class="text-danger form-text" ng-show="CustomerCareCase.baseProduct{{$index}}.$error.required && CustomerCareCase.baseProduct{{$index}}.$dirty">
												<a th:text="#{ccc.baseProduct_req}"></a> 
											</small>
		    </div>
			<div class="col-sm-1" style="padding-left: 0px">
											<button type="button" class="btn btn-default" ng-click="removeBaseProductLineItem(baseProductLineItem)">
												<i class="fas fa-trash-alt"></i>
											</button>
										</div>
			<div class="col-sm-1" style="padding-left: 0px">
										<button type="button" class="btn btn-default" ng-click="addBaseProductLineItem()">
											<i class="fas fa-plus"></i>
										</button>
										<input type="hidden" id="relatedProductBaseCodeList" name="relatedProductBaseCodeList" 
										th:value="${#strings.arrayJoin(CustomerCareCase.relatedProductBaseCodeList,',')}" />
									</div>
		  </div>

		  	</div>
							</div>




		<div id="sku">
			<div ng-repeat="SKULineItem in SKULineItems">
		  <div class="form-group row">
		    <label for="sku" class="col-sm-4 col-form-label">SKU</label>
		    <div class="col-sm-6">
		      <select id="sku{{$index}}" class="form-control" name="sku{{$index}}" ng-model="SKULineItem.sku" ng-change="updateSkuList()" required>
											</select>											
											<small class="text-danger form-text" ng-show="CustomerCareCase.sku{{$index}}.$error.required && CustomerCareCase.sku{{$index}}.$dirty">
												<a th:text="#{ccc.sku_req}"></a>
											</small>

		    </div>
		    <div class="col-sm-1" style="padding-left: 0px">
											<button type="button" class="btn btn-default" ng-click="removeSKULineItem(SKULineItem)">
												<i class="fas fa-trash-alt"></i>
											</button>
										</div>
			<div class="col-sm-1" style="padding-left: 0px">
										<button type="button" class="btn btn-default" ng-click="addSKULineItem()">
											<span class="fas fa-plus"></span>
										</button>
										<input type="hidden" id="relatedProductSkuCodeList" name="relatedProductSkuCodeList" 
										th:value="${#strings.arrayJoin(CustomerCareCase.relatedProductSkuCodeList,',')}" />
									</div>
									</div>
		  </div>
			</div>
		</div>






			<div class="col-md-6">

			<div class="form-group row">
		    <label for="issueTypeCategory" class="col-sm-4 col-form-label"><a th:text="#{ccc.issueCategory}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		        <select id="issueTypeCategory" class="form-control" name="issueTypeCategoryId" ng-model="issueTypeCategory" ng-change="getIssueTypeToIssues()" th:required="required">
								<a th:text="#{issue.ALL_CATEGORY}"></a>
								<option value="" th:text="#{issue.ALL_CATEGORY}"></option>
								<th:block th:each="categoryIdToName : ${categoryIdToNameMap}">									
								<option th:value="${categoryIdToName.key}" th:text="#{'issue.'+${categoryIdToName.value}}" th:selected="${categoryIdToName.key}==${CustomerCareCase.issueTypeCategoryId}"></option>								
								</th:block>							
				</select>						
							<small class="text-danger form-text" ng-show="CustomerCareCase.issueTypeCategoryId.$error.required && CustomerCareCase.issueTypeCategoryId.$dirty">
								<a th:text="#{ccc.issueCategory_req}"></a>
							</small>
		    </div>
		  </div>

		  <div class="form-group row">
		    <label for="example-multiple-optgroups" class="col-sm-4 col-form-label"><a th:text="#{ccc.issue}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <select  id="example-multiple-optgroups" name="relatedIssueIds" multiple="multiple" ng-model="relatedIssueIds" th:required="required">
				  
							</select>						
							<div class="text-danger" ng-show="CustomerCareCase.relatedIssueIds.$error.required && CustomerCareCase.relatedIssueIds.$dirty">
								<a th:text="#{ccc.issue_req}"></a>
							</div>
		    </div>
		  </div>

		  			<div class="form-group row">
		  			<div class="col-sm-12 offset-sm-4">
		   <a class="btn btn-link" target="_blank" th:href="@{/Issues/create}" th:text="#{issue.createIssue}"></a>
								
					</div>
		  </div>

		  <div class="form-group row">
		    <label for="dateCreated" class="col-sm-4 col-form-label"><a th:text="#{ccc.customerContactTime}"></a><span class="text-danger">*</span></label>
		    <div class="col-sm-8">
		      <input id="dateCreated" class="form-control" style="display:inline;cursor:default;background-color:white;" name="dateCreated" th:value="${CustomerCareCase.dateCreated}" ng-model="dateCreated" required="required"/>
							<small class="text-danger form-text" ng-show="CustomerCareCase.dateCreated.$error.required && CustomerCareCase.dateCreated.$dirty">
								<a th:text="#{ccc.customerContactTime_req}"></a>
							</small>
		    </div>
		  </div>

			  <div class="form-group row">
		    <label for="status" class="col-sm-4 col-form-label"><a th:text="#{ccc.status}"></a></label>
		    <div class="col-sm-8">
		      <select id="status" class="form-control" name="status">
 								<option value="processing" th:text="#{ccc.processing}"  th:selected="${CustomerCareCase.status} == 'processing'"></option>
 								<option value="waitingForCustomerResponse" th:text="#{ccc.waitingForCustomerResponse}" th:selected="${CustomerCareCase.status} == 'waitingForCustomerResponse'"></option>
 								<option value="caseClosed" th:text="#{ccc.caseClosed}" th:selected="${CustomerCareCase.status} == 'caseClosed'"></option>																												
								 </select>
		    </div>
		  </div>

			</div>
		</div>

		<div class="row my-3">
			<div class="col-md-12">
				<label><a th:text="#{ccc.origMsg}"></a><span class="text-danger">*</span></label>
				<th:block th:each="ms ,message : ${CustomerCareCase.messages}" >
					<div th:if="${message.last} == true ">
						<textarea th:id="'originalMessageFromCustomer'+${message.index}"
							class="form-control" th:name="message[__${message.index}__].contents"
							th:text="${CustomerCareCase.message[__${message.index}__].contents}"
							rows="4" ng-model="message" th:required="required"  ></textarea>
						<input type="hidden" th:name="message[__${message.index}__].lineSeq" th:value="${CustomerCareCase.message[__${message.index}__].lineSeq}" />
						<div class="text-danger" ng-show="CustomerCareCase['message[${message.index}].contents'].$error.required && CustomerCareCase['message[${message.index}].contents'].$dirty">
							<a th:text="#{ccc.origMsg_req}"></a>
						</div>	
					</div>
				</th:block>
			</div>
		</div>
		<div class="row">
			<div class="col-md-12 text-right">							
				<input class="btn btn-primary" type="submit" th:value="#{ccc.submit}" ng-disabled="CustomerCareCase.$invalid" onclick="this.form.submit()" />
			    
					<span th:if="${type eq 'Edit'}">		
						<a class="btn btn-link" th:href="@{/CustomerCareCases/{caseId}(caseId=${CustomerCareCase.caseId})}"
							th:text="#{ccc.cancel}" >
						</a>
					</span>
			</div>
		</div>
	</form>
	</div>
	</div>
</div>
</section>
</body>
</html>