package com.kindminds.drs.core.actors

import akka.actor.{ActorSystem, Props}
import akka.testkit.{ImplicitSender, TestActorRef, TestKit, TestProbe}
import com.kindminds.drs.api.message.command.p2m.{CreateP2MApplication, SubmitP2MApplication}
import com.kindminds.drs.api.message.event.{P2mApplicationCreated, P2mApplicationSubmitted}
import com.kindminds.drs.biz.service.util.BizCoreCtx
import com.kindminds.drs.core.actors.handlers.command.p2m.P2MCmdHandler
import com.kindminds.drs.core.{DrsCmdBus, DrsEventBus, DrsQueryBus}
import org.scalatest.{BeforeAndAfterAll, Matchers, WordSpecLike}

import scala.concurrent.duration._

class TestP2MCmdHandler  extends TestKit(ActorSystem("system"))
  with ImplicitSender
  with WordSpecLike with Matchers with BeforeAndAfterAll{

  val probe = TestProbe()
  val drsQueryBus = TestActorRef.create(system, Props.create(classOf[DrsQueryBus]), "DrsQueryBus")
  val drsCmdBus = TestActorRef.create(system, Props.create(classOf[DrsCmdBus]), "DrsCmdBus")
  val drsEventBus = new DrsEventBus

  val p2MApplication = TestActorRef(P2MCmdHandler.props(drsCmdBus,drsEventBus))

  "Actor" must {

    within(30000 millis) {


        BizCoreCtx.get

      //p2MApplication ! CreateP2MApplication("{\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+\",\"type\":\"update\",\"status\":\"draft\",\"supplierId\":\"190\",\"appliedDate\":\"2021/03/05\",\"approvedDate\":\"\",\"rejectedDate\":\"\",\"cancelledDate\":\"\",\"brandNameEN\":\"SuperComfy\",\"productNameEN\":\"Nicolas Cage PillowCase ＋＿＋+_+\",\"bpId\":\"5ffbc08024a4fa23b0932638\",\"appliedSkuCode\":[],\"appliedSku\":[{\"sellerSku\":\"K618\",\"productId\":{\"name\":\"Product ID\",\"value\":\"500000000\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variable\":{\"name\":\"Variable\",\"value\":\"small\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color\"},\"pageIndex\":1,\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"status\":\"unapplied\",\"actions\":[\"申請銷售\",\"修改\"],\"editable\":true,\"isSelected\":null},{\"sellerSku\":\"K619\",\"productId\":{\"name\":\"Product ID\",\"value\":\"200000000\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variable\":{\"name\":\"Variable\",\"value\":\"medium\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color\"},\"pageIndex\":1,\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"status\":\"unapplied\",\"actions\":[\"申請銷售\",\"修改\"],\"editable\":true,\"isSelected\":null},{\"sellerSku\":\"K620\",\"productId\":{\"name\":\"Product ID\",\"value\":\"1000000000\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variable\":{\"name\":\"Variable\",\"value\":\"large\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color\"},\"pageIndex\":1,\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"status\":\"unapplied\",\"actions\":[\"申請銷售\",\"修改\"],\"editable\":true,\"isSelected\":null},{\"sellerSku\":\"K621\",\"productId\":{\"name\":\"Product ID\",\"value\":\"3000000000\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variable\":{\"name\":\"Variable\",\"value\":\"XL\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color\"},\"pageIndex\":1,\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"status\":\"unapplied\",\"actions\":[\"申請銷售\",\"修改\"],\"editable\":true,\"isSelected\":null}],\"country\":\"\",\"platform\":\"\",\"subApplication\":{\"marketPlaceInfo\":{\"type\":\"MarketPlace Information\",\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+-MarketPlace-Information\",\"status\":\"draft\",\"ref_id\":\"\",\"main\":{\"imgUrl\":\"\",\"title\":\"\",\"description\":\"\",\"feature\":[\"\",\"\",\"\",\"\",\"\"],\"keyword\":[\"\",\"\",\"\",\"\",\"\"]},\"appliedSku\":[]},\"insurance\":{\"type\":\"Insurance\",\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+-Insurance\",\"status\":\"draft\",\"ref_id\":\"\",\"appliedSku\":[],\"hasInsured\":\"no\",\"inquiryForm\":[{\"name\":\"Choose a file\"}],\"agreedQuotation\":\"no\",\"quotationFromDrs\":[],\"quotationFromSupplier\":[{\"name\":\"Choose a file\"}],\"insuranceFiles\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"insuredProductName\":\"\",\"insuredRegions\":[],\"insuredValidDate\":\"2021-04-07T09:15:58.436Z\",\"agreement\":false}],\"updatedInsuranceFiles\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"insuredProductName\":\"\",\"insuredRegions\":[],\"insuredValidDate\":\"2021-04-07T09:15:58.436Z\",\"agreement\":false}]},\"regional\":{\"type\":\"Regional\",\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+-Regional\",\"status\":\"draft\",\"ref_id\":\"\",\"isWooden\":\"no\",\"isBattery\":\"no\",\"isWireless\":\"no\",\"appliedSku\":[],\"woodenFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"wirelessFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"batteryFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"otherFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"description\":\"\"}],\"patentFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"modelNumber\":\"\",\"documentType\":\"\",\"documentValidDate\":\"2021-04-07T09:15:58.436Z\",\"certificationBody\":\"\",\"complianceType\":\"\"}],\"certificateFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"modelNumber\":\"\",\"documentType\":\"\",\"documentValidDate\":\"2021-04-07T09:15:58.436Z\",\"certificationBody\":\"\",\"complianceType\":\"\"}],\"packageFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"manualFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}]},\"shipping\":{\"type\":\"Shipping\",\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+-Shipping\",\"status\":\"draft\",\"ref_id\":\"\",\"appliedSku\":[],\"checkReturn\":false,\"haslocalWarehouse\":\"yes\",\"psAllSkuApplied\":\"yes\",\"ppsAllSkuApplied\":\"yes\",\"ppwAllSkuApplied\":\"yes\",\"allIncludePackageWeight\":0,\"allIncludePackageHeight\":0,\"allIncludePackageLength\":0,\"allIncludePackageWidth\":0,\"allNetWeight\":0,\"allNetLength\":0,\"allNetWidth\":0},\"productInfo\":{\"type\":\"Product Information\",\"name\":\"AP-001-Nicolas Cage PillowCase ＋＿＋+_+-Product-Information\",\"status\":\"draft\",\"ref_id\":\"\",\"appliedSku\":[],\"urlAllSkuApplied\":\"yes\",\"startDateAllSkuApplied\":\"yes\",\"manufactureDaysAllSkuApplied\":\"yes\",\"manufacturePlaceAllSkuApplied\":\"yes\",\"competitorInfoAllSkuApplied\":\"yes\",\"url\":\"\",\"startDate\":\"2021-04-07T09:15:58.436Z\",\"manufactureDays\":\"\",\"manufacturePlace\":\"\",\"competitorInfo\":\"\"}}}")
      p2MApplication ! CreateP2MApplication("{\"name\":\"AP-001-pencil\",\"type\":\"new\",\"supplierId\":\"K102\",\"appliedDate\":\"2021/03/05\",\"approvedDate\":\"\",\"rejectedDate\":\"\",\"cancelledDate\":\"\",\"returnTimes\":0,\"selectedProduct\":\"pencil\",\"selectedCountry\":\"台灣\",\"selectedPlatform\":\"Amazon.tw\",\"brandNameEN\":\"Pencil\",\"productNameEN\":\"pencil\",\"bpId\":\"60da819d1a5b0a608f835906\",\"appliedSkuCode\":[\"WS\"],\"appliedSku\":[{\"sellerSku\":\"WS\",\"productId\":{\"name\":\"Product ID\",\"value\":\"789797777\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color & Size\"},\"variable\":{\"name\":\"Variable\",\"value\":\"white & S\"},\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"applying\":[],\"selling\":[],\"status\":\"\",\"actions\":[\"申請銷售\",\"修改\"],\"pageIndex\":1,\"editable\":true,\"isSelected\":true},{\"sellerSku\":\"WL\",\"productId\":{\"name\":\"Product ID\",\"value\":\"789797775\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color & Size\"},\"variable\":{\"name\":\"Variable\",\"value\":\"white & L\"},\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"applying\":[],\"selling\":[],\"status\":\"\",\"actions\":[\"申請銷售\",\"修改\"],\"pageIndex\":1,\"editable\":true,\"isSelected\":true},{\"sellerSku\":\"BS\",\"productId\":{\"name\":\"Product ID\",\"value\":\"789797776\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"UPC\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color & Size\"},\"variable\":{\"name\":\"Variable\",\"value\":\"black & S\"},\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"applying\":[],\"selling\":[],\"status\":\"\",\"actions\":[\"申請銷售\",\"修改\"],\"pageIndex\":1,\"editable\":true,\"isSelected\":true},{\"sellerSku\":\"BL\",\"productId\":{\"name\":\"Product ID\",\"value\":\"789797778\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"UPC\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color & Size\"},\"variable\":{\"name\":\"Variable\",\"value\":\"black & L\"},\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"applying\":[],\"selling\":[],\"status\":\"\",\"actions\":[\"申請銷售\",\"修改\"],\"pageIndex\":1,\"editable\":true,\"isSelected\":true}],\"country\":\"台灣\",\"platform\":\"Amazon.tw\",\"subApplication\":{\"marketPlaceInfo\":{\"type\":\"MarketPlace Information\",\"name\":\"AP-001-pencil-MarketPlace-Information\",\"ref_id\":\"\",\"main\":{\"imgUrl\":\"\",\"title\":\"\",\"description\":\"\",\"feature\":[\"\",\"\",\"\",\"\",\"\"],\"keyword\":[\"\",\"\",\"\",\"\",\"\"],\"comment\":{\"img\":\"\",\"title\":\"\",\"description\":\"\",\"feature\":\"\",\"keyword\":\"\"}},\"appliedSku\":[{\"sellerSku\":\"WS\",\"productId\":{\"name\":\"Product ID\",\"value\":\"789797777\"},\"productIdType\":{\"name\":\"Product ID Type\",\"value\":\"EAN\"},\"variationTheme\":{\"name\":\"Variation Theme\",\"value\":\"Color & Size\"},\"variable\":{\"name\":\"Variable\",\"value\":\"white & S\"},\"retailPrice\":\"未定價\",\"salesVolume\":0,\"openPosition\":0,\"fbaQuantity\":0,\"applying\":[],\"selling\":[],\"status\":\"\",\"actions\":[\"申請銷售\",\"修改\"],\"pageIndex\":1,\"editable\":true,\"isSelected\":true,\"skuCode\":\"WS\",\"variationNameForMarketplace\":\"\",\"imgUrl\":\"\",\"title\":\"\",\"description\":\"\",\"feature\":[\"\",\"\",\"\",\"\",\"\"],\"keyword\":[\"\",\"\",\"\",\"\",\"\"],\"comment\":{\"variationNameForMarketplace\":\"\",\"img\":\"\",\"title\":\"\",\"description\":\"\",\"feature\":\"\",\"keyword\":\"\"}}],\"competitorInfo\":\"\",\"comment\":{\"competitorInfo\":\"\"}},\"insurance\":{\"type\":\"Insurance\",\"name\":\"AP-001-pencil-Insurance\",\"ref_id\":\"\",\"appliedSku\":[{\"skuCode\":\"WS\",\"supplierInsuranceFile\":[{\"name\":\"\",\"insuredProductName\":\"\",\"insuredRegions\":[],\"insuredValidDate\":\"2021-06-30T08:20:07.028Z\",\"agreement\":\"\"}]}],\"hasInsured\":\"no\",\"inquiryForm\":[{\"name\":\"Choose a file\"}],\"quotationFromDrs\":[{\"name\":\"Choose a file\"}],\"signedQuotation\":[{\"name\":\"Choose a file\"}],\"insuranceFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"insuredProductName\":\"\",\"insuredRegions\":[],\"insuredValidDate\":\"2021-06-30T08:20:07.028Z\",\"agreeOfAdditionalInsured\":false,\"agreeOfAdditionalFee\":false}],\"updatedInsuranceFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"insuredProductName\":\"\",\"insuredRegions\":[],\"insuredValidDate\":\"2021-06-30T08:20:07.028Z\",\"agreeOfAdditionalInsured\":false,\"agreeOfAdditionalFee\":false}],\"reviewOfInsurance\":\"\",\"caseTypeOfInsure\":\"\",\"process\":\"ph-1\",\"steps\":[{\"name\":\"insurance.step1\",\"state\":\"active\"},{\"name\":\"insurance.step2\",\"state\":\"\"},{\"name\":\"insurance.step3\",\"state\":\"\"},{\"name\":\"insurance.step4\",\"state\":\"\"},{\"name\":\"insurance.step5\",\"state\":\"\"},{\"name\":\"insurance.step6\",\"state\":\"\"},{\"name\":\"insurance.step7\",\"state\":\"\"}]},\"regional\":{\"type\":\"Regional\",\"name\":\"AP-001-pencil-Regional\",\"ref_id\":\"\",\"appliedSku\":[{\"skuCode\":\"WS\",\"productImg\":[],\"certificateFile\":[],\"patentFile\":[],\"otherFile\":[]}],\"otherFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"description\":\"\"}],\"patentFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"modelNumber\":\"\",\"documentType\":\"\",\"documentValidDate\":\"2021-06-30T08:20:07.028Z\",\"certificationBody\":\"\",\"complianceType\":\"\"}],\"certificateFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"modelNumber\":\"\",\"documentType\":\"\",\"documentValidDate\":\"2021-06-30T08:20:07.028Z\",\"certificationBody\":\"\",\"complianceType\":\"\"}],\"comment\":{\"otherFile\":\"\",\"patentFile\":\"\",\"certificateFile\":\"\",\"productImg\":\"\"}},\"shipping\":{\"type\":\"Shipping\",\"name\":\"AP-001-pencil-Shipping\",\"ref_id\":\"\",\"appliedSku\":[{\"skuCode\":\"WS\",\"netWidth\":0,\"netHeight\":0,\"netLength\":0,\"includePackageWidth\":0,\"includePackageHeight\":0,\"includePackageLength\":0,\"includePackageWeight\":0}],\"checkReturn\":false,\"haslocalWarehouse\":\"yes\",\"psAllSkuApplied\":\"yes\",\"ppsAllSkuApplied\":\"yes\",\"ppwAllSkuApplied\":\"yes\",\"allIncludePackageWeight\":0,\"allIncludePackageHeight\":0,\"allIncludePackageLength\":0,\"allIncludePackageWidth\":0,\"allNetWeight\":0,\"allNetLength\":0,\"allNetWidth\":0,\"allNetHeight\":0,\"comment\":{\"shippingMethod\":\"\",\"shippingInfo\":\"\"}},\"productInfo\":{\"type\":\"Product Advanced Information\",\"name\":\"AP-001-pencil-Product-Advanced-Information\",\"ref_id\":\"\",\"appliedSku\":[{\"skuCode\":\"WS\",\"url\":\"\",\"startDate\":\"2021-06-30T08:20:07.028Z\",\"manufactureDays\":\"\",\"manufacturePlace\":\"\",\"packageFile\":[],\"packageImg\":[],\"manualFile\":[],\"manualImg\":[],\"exportSideHsCode\":\"\",\"salesSideHsCode\":\"\",\"ingredient\":\"\",\"woodenFile\":[],\"wirelessFile\":[],\"batteryFile\":[]}],\"urlAllSkuApplied\":\"yes\",\"startDateAllSkuApplied\":\"yes\",\"manufactureDaysAllSkuApplied\":\"yes\",\"manufacturePlaceAllSkuApplied\":\"yes\",\"url\":\"\",\"startDate\":\"2021-06-30T08:20:07.028Z\",\"manufactureDays\":\"\",\"manufacturePlace\":\"\",\"packageFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"manualFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"woodenFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"wirelessFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[]}],\"batteryFile\":[{\"name\":\"Choose a file\",\"appliedSku\":[],\"batteryCategory\":\"\"}],\"isWooden\":\"no\",\"isBattery\":\"no\",\"isWireless\":\"no\",\"comment\":{\"url\":\"\",\"startDate\":\"\",\"manufactureDays\":\"\",\"manufacturePlace\":\"\",\"productId\":\"\",\"packageImg\":\"\",\"packageFile\":\"\",\"manualImg\":\"\",\"manualFile\":\"\",\"woodenFile\":\"\",\"wirelessFile\":\"\",\"batteryFile\":\"\",\"hsCode\":\"\",\"ingredient\":\"\"}}}}",534)


    }
  }



}
